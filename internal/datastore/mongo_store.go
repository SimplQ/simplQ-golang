package datastore

import (
	"context"
	"errors"
	"log"
	"os"

	"github.com/SimplQ/simplQ-golang/internal/models/db"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/bson/primitive"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

// A Structure with Collections frequently used and a pointer to the client
type MongoDB struct {
	Client *mongo.Client
	Queue  *mongo.Collection
	Token  *mongo.Collection
}

func NewMongoDB() *MongoDB {
	// Use local development mongodb instance if env variable not set
	uri := "mongodb://root:example@localhost:27017/?maxPoolSize=20&w=majority"

	if val, ok := os.LookupEnv("MONGO_URI"); ok {
		uri = val
	}

	log.Println("Connecting to MongoDB...")

	client, err := mongo.Connect(context.TODO(), options.Client().ApplyURI(uri))

	if err != nil {
		log.Fatal(err)
	}

	new_mongodb := MongoDB{
		client,
		client.Database("simplq").Collection("queue"),
		client.Database("simplq").Collection("token"),
	}

	log.Println("Successfully connected to MongoDB!")

	return &new_mongodb
}

func (mongodb MongoDB) CreateQueue(queue db.Queue) (db.QueueId, error) {
	// Set id to empty so its generated by mongoDB
	queue.Id = ""

	result, err := mongodb.Queue.InsertOne(context.TODO(), queue)

	if err != nil {
		return queue.Id, err
	}

	stringId := result.InsertedID.(primitive.ObjectID).Hex()

	return db.QueueId(stringId), nil
}

func (mongodb MongoDB) ReadQueue(id db.QueueId) (db.Queue, error) {
	result := db.Queue{}

	// convert id string to ObjectId
	queueId, _ := primitive.ObjectIDFromHex(string(id))

	err := mongodb.Queue.FindOne(context.TODO(), bson.M{"_id": queueId}).Decode(&result)

	if err != nil {
		return result, err
	}

	return result, nil
}

func (mongodb MongoDB) SetIsPaused(id db.QueueId, isPaused bool) error {
	queueId, _ := primitive.ObjectIDFromHex(string(id))
	result, err := mongodb.Queue.UpdateOne(
		context.TODO(),
		bson.M{"_id": queueId},
		bson.D{
			{Key: "$set", Value: bson.D{primitive.E{Key: "isPaused", Value: isPaused}}},
		},
	)
	if err != nil {
		return err
	}
	log.Printf("Records updated:%d", result.ModifiedCount)
	if result.ModifiedCount == 0 {
		return errors.New("no record found")
	}
	return nil

}

func (mongodb MongoDB) DeleteQueue(id db.QueueId) error {
	queueId, _ := primitive.ObjectIDFromHex(string(id))
	result, err := mongodb.Queue.DeleteOne(
		context.TODO(),
		bson.M{"_id": queueId})

	if err != nil {
		return err
	}
	log.Printf("Records deleted:%d", result.DeletedCount)
	if result.DeletedCount == 0 {
		return errors.New("no record found")
	}
	return nil
}

func (mongodb MongoDB) AddTokenToQueue(id db.QueueId, token db.Token) (db.TokenId, error) {
	token.Id = ""
	token.QueueId = id

	result, err := mongodb.Token.InsertOne(context.TODO(), token)

	if err != nil {
		return token.Id, err
	}

	stringId := result.InsertedID.(primitive.ObjectID).Hex()

	return db.TokenId(stringId), nil
}

func (mongodb MongoDB) ReadToken(db.TokenId) (db.Token, error) {
	panic("Not implemented")
}

func (mongodb MongoDB) RemoveToken(db.TokenId) error {
	panic("Not implemented")
}
